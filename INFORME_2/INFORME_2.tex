\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{lipsum} % Paquete para generar texto de prueba
\usepackage{graphicx} % Para incluir imágenes
\usepackage{tikz} % Para dibujar figuras

\usepackage{geometry} % Para ajustar el tamaño del texto y los márgenes
% Ajusta el tamaño del texto y los márgenes
\geometry{
    left=30mm, % Margen izquierdo
    top=25mm, % Margen superior
}
\usepackage{float} % Para la opción [H]
\usepackage{enumitem}
\usepackage[spanish]{babel} % Cargar el idioma español

\usepackage{listings}

% Configuración del estilo de las celdas de código
\lstset{
  frame=single, % Agrega un marco alrededor del código
  language=Python, % Lenguaje del código
  basicstyle=\ttfamily\small, % Estilo básico del texto del código
  keywordstyle=\color{blue}, % Estilo de las palabras clave
  commentstyle=\color{green!40!black}, % Estilo de los comentarios
  stringstyle=\color{red}, % Estilo de las cadenas de texto
  showstringspaces=false, % No mostrar espacios en cadenas de texto
  captionpos=b, % Posición de la leyenda (abajo)
}
\lstset{
  literate=%
  {á}{{\'a}}1
  {é}{{\'e}}1
  {í}{{\'i}}1
  {ó}{{\'o}}1
  {ú}{{\'u}}1
  {ñ}{{\~n}}1
}



\usepackage{hyperref}

\title{\textbf{MULTIPLES DISPAROS SINCRONIZADOS}\\[0.5em] \large Investigacion UHPC}
\author{Lukas Wolff Casanova}
\date{\today}
\begin{document}

\maketitle
\hrule

\section{INTRODUCCION}

\noindent Posterior a sincronizar las cámaras, se determinó que la siguiente tarea era lograr sacar 5000 por cámara, lo que da un rango de operación de 25 segundos a 
200 fps. Para poder lograrlo se postularon varias ideas como listas concatenadas, determinar el tamaño de la lista o usar el buffer de las cámaras.

\section{METODOLOGÍA}

\noindent Para comenzar se investigó sobre las listas concatenadas o listas con punteros. La diferencia que tienen con una lista normal es que en vez de estar
almacenadas de manera conjunta en la memoria RAM, estos datos se almacenan de forma particular, junto a un puntero que indica dónde está el siguiente
índice, de esta manera se logra que el proceso de almacenar datos sea mucho más eficiente en términos de velocidad y memoria, pero tiene como contra que recorrer 
una lista es más lento. Tomando a favor la estructura del código, donde se recorre la lista una vez que las fotos ya fueron tomadas, se determinó que era una
buena herramienta a utilizar.
\\ \\
Además, se activó el buffer de la cámara, el cual de igual manera envía una foto por ciclo al computador, pero ayuda a que la cámara no se sature.
\\ \\
En primer lugar se crea la clase \textit{node}, la cual permite crear y recorrer una lista concatenada. La celda más importante del 
código es la siguiente:

\begin{lstlisting}[language=Python]
  # Método para recorrer la lista de nodos
  def traverse(self):
      current_node = self.head
      
      while current_node:

          img = current_node.data.GetArray()
          img = cv2.equalizeHist(img)
          camara = current_node.data.GetCameraContext()
          tiempo = current_node.data.GetTimeStamp()

          # Carpeta donde se almacenarán las imágenes
          folder_path = f'FOTOS/{RPM}/{camara}'
          print(folder_path)

          # Crear la carpeta si no existe
          if not os.path.exists(folder_path):
              os.makedirs(folder_path)

          # Nombre del archivo de la imagen
          file_name = f'{tiempo}.png'

          # Ruta completa del archivo de la imagen
          file_path = os.path.join(folder_path, file_name)

          # Crear una imagen PIL a partir de la matriz de la imagen
          image = Image.fromarray(img)

          # Guardar la imagen como PNG
          image.save(file_path)

          print(f"Imagen guardada: {file_path}")
          current_node = current_node.next
\end{lstlisting}

\noindent Como se puede ver, todo el proceso que se realizaba anteriormente al recorrer la lista de imágenes, ahora
se realiza dentro de la clase \textit{node}, la cual es llamada al final del código:
\\ \\
Posteriormente, se configuran los ajustes tanto de cámaras como de fotos:

\begin{lstlisting}
  #---------------------
  # DETERMINO EL NOMBRE DE CARPETA
  RPM = 12055

  # DETERMINO CANTIDAD DE IMAGENES A SACAR
  countOfImagesToGrab = 5000
  #---------------------
\end{lstlisting}

\noindent Donde el directorio final de las fotos será el siguiente:

\begin{center}
  FOTOS/RPM/numero-camara/tiempo-foto.jpg
\end{center}

\noindent Posteriormente, se configuran las cámaras:

\begin{lstlisting}
  # Create and attach all Pylon Devices.
  for i, cam in enumerate(cameras):
      
    cam.Attach(tlFactory.CreateDevice(devices[i]))

    # Open the camera to set parameters
    cam.Open()

    # Buffer Size Adjustment
    cam.MaxNumBuffer = buffer  # Adjust buffer size as needed
    
    # Configure camera settings
    cam.AcquisitionFrameRateEnable.SetValue(True)
    cam.AcquisitionFrameRate.SetValue(200)
    cam.ExposureTime.SetValue(100) 

    # Close the camera after setting parameters
    cam.Close()
\end{lstlisting}

\newpage
\noindent Comienza el \textit{trigger}:

\begin{lstlisting}
  #----------------------
  # Disparo las camaras
  cameras.StartGrabbing()
  #----------------------
\end{lstlisting}

\noindent Y se almacenan las fotos:

\begin{lstlisting}
  for i in range(countOfImagesToGrab):
    if not cameras.IsGrabbing():
        break

    #recibo la foto y la guardo como array y en la lista concatenada
    R = cameras.RetrieveResult(40000, pylon.TimeoutHandling_ThrowException)
    s.add_at_front(R)
\end{lstlisting}

\noindent Finalmente, se recorre la lista:

\begin{lstlisting}
  s.traverse()
  print("Fotos Guardadas")
\end{lstlisting}

\newpage
\section{RESULTADOS}

\noindent Se hizo una toma de 10,000 fotos en total a 200 fps, lo que equivale a 5,000 fotos por cámara. A continuación se presentan los resultados cada 1,000 fotos para
demostrar que se mantiene la sincronización

\subsection{MOMENTO INICIAL}

\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/846596744730.png}
    \caption{Imagen 0 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/854397768249.png}
    \caption{Imagen 0 camara 1}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/846601745022.png}
    \caption{Imagen 1 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/854402768568.png}
    \caption{Imagen 1 camara 1}
  \end{minipage}
\end{figure}

\subsection{FOTOS 1000}

\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/849096897507.png}
    \caption{Imagen 500 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/856897921026.png}
    \caption{Imagen 500 camara 1}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/849101897799.png}
    \caption{Imagen 501 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/856902921345.png}
    \caption{Imagen 501 camara 1}
  \end{minipage}
\end{figure}

\subsection{FOTOS 2000}

\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/851592049965.png}
    \caption{Imagen 1000 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/859393073511.png}
    \caption{Imagen 999 camara 1}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/851597050284.png}
    \caption{Imagen 1001 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/859398073803.png}
    \caption{Imagen 1000 camara 1}
  \end{minipage}
\end{figure}

\noindent En este caso se puede observar que el índice de la cámara 1 disminuye en 1, lo cual indica que la cámara 1 tiene una foto extra en el intervalo [1000-2000].

\subsection{FOTOS 3000}

\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/854092202742.png}
    \caption{Imagen 1500 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/861893226288.png}
    \caption{Imagen 1499 camara 1}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/854097203061.png}
    \caption{Imagen 1501 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/861898226580.png}
    \caption{Imagen 1500 camara 1}
  \end{minipage}
\end{figure}

\subsection{FOTOS 4000}

\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/856592355519.png}
    \caption{Imagen 2000 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/864393379065.png}
    \caption{Imagen 1999 camara 1}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/856597355838.png}
    \caption{Imagen 2001 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/864398379357.png}
    \caption{Imagen 2000 camara 1}
  \end{minipage}
\end{figure}

\subsection{FOTOS 5000}

\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/859092508323.png}
    \caption{Imagen 2500 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/866893531842.png}
    \caption{Imagen 2499 camara 1}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/859097508615.png}
    \caption{Imagen 2501 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/866898532161.png}
    \caption{Imagen 2500 camara 1}
  \end{minipage}
\end{figure}

\subsection{FOTOS 6000}

\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/861592661073.png}
    \caption{Imagen 3000 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/869393684619.png}
    \caption{Imagen 2999 camara 1}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/861597661392.png}
    \caption{Imagen 3001 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/869398684911.png}
    \caption{Imagen 3000 camara 1}
  \end{minipage}
\end{figure}

\subsection{FOTOS 7000}

\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/864092813850.png}
    \caption{Imagen 3500 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/871893837396.png}
    \caption{Imagen 3499 camara 1}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/864097814169.png}
    \caption{Imagen 3501 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/871898837688.png}
    \caption{Imagen 3500 camara 1}
  \end{minipage}
\end{figure}

\subsection{FOTOS 8000}

\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/866592966654.png}
    \caption{Imagen 4000 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/874393990173.png}
    \caption{Imagen 3999 camara 1}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/0/866597966946.png}
    \caption{Imagen 4001 camara 0}
  \end{minipage}
  \begin{minipage}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.6
    \textwidth]{FOTOS/8362/1/874398990492.png}
    \caption{Imagen 4000 camara 1}
  \end{minipage}
\end{figure}

\subsection{FOTOS 9000}

\noindent Es curioso este caso, ya que al hacer un código que busque las fotos 9000, si encuentra su presencia en las carpetas, pero luego al agregarlas en el informe.tex,
este no logra encontrarlas, por lo que quizás no se logró su interpretación de array a imagen de manera correcta.

\subsection{ANALISIS}

\noindent Se puede observar claramente que la sincronización se mantiene a lo largo de las tomas, ahora bien, hay que tener precaución con el análisis de imágenes y la pérdida de datos,
por lo que será necesario modificar o crear un código que analice el desfase entre fotos, y sea capaz de determinar si hay fotos extra o vacíos. 

\section{CONCLUSION}

\noindent En conclusión, se logró el objetivo principal de sacar 10,000 fotos, ahora bien, surgieron ciertos detalles que hay que arreglar. De todas formas, ya existe una buena
base donde se puede empezar a trabajar para la implementación del PTV a medida que se arreglan los detalles finales.
\\ \\
Finalmente, la siguiente gran tarea es comenzar a aprender e implementar el uso de PTV, además de arreglar los detalles antes mencionados.
\\ \\
\noindent Enlace a GitHub con toda la información: \href{https://github.com/LukasWolff2002/SINCRONIZACION_CAMARAS_BASLER}{GIT-HUB-INVESTIGACION-UHPC}.
\\ \\
\noindent Enlace a GitHub con codigo base: : \href{https://github.com/basler/pypylon/blob/master/samples/grabmultiplecameras.py}{GIT-HUB-CODIGO-BASE}.


\end{document}
